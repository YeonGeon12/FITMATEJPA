<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>FITMATE | 운동 루틴 추천 결과</title>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/history/historyDetail.css">
    <link rel="stylesheet" href="/css/user/profileForm.css"> </head>
<body>
<div id="toast" class="toast"></div>
<div class="wrapper">
    <header class="main-header" th:replace="~{index :: .main-header}"></header>

    <main class="detail-main-content">
        <div class="detail-container">
            <h1>운동 루틴 추천</h1>
            <p class="subtitle">AI가 당신의 요구를 위해 맞춤 운동 루틴을 만들었습니다.</p>

            <div class="routine-section">
                <div id="routine-container">
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                <a th:href="@{/exercise/exerciseForm}" class="back-link">← 다시 추천 받기</a>
                <button id="saveBtn" class="save-btn" style="width: auto;">루틴 저장하기</button>
            </div>
        </div>
    </main>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. sessionStorage에서 AI 추천 결과와 사용자 요청 파라미터를 가져옵니다.
        const routineJsonString = sessionStorage.getItem('exerciseResult');
        const requestParams = JSON.parse(sessionStorage.getItem('requestParams'));
        const container = document.getElementById('routine-container');

        // 2. 데이터가 없으면 오류 메시지를 표시하고 종료합니다.
        if (!routineJsonString || !requestParams) {
            container.innerHTML = '<p style="text-align: center;">추천 결과를 불러오지 못했습니다. 다시 시도해주세요.</p>';
            return;
        }

        // 3. 받아온 JSON 문자열을 객체로 변환합니다.
        const routineData = JSON.parse(routineJsonString);
        const weekRoutine = routineData.weekRoutine;
        let routineDetailsForSave = []; // MongoDB에 저장할 데이터를 담을 배열

        // 4. 받아온 루틴 데이터를 기반으로 동적으로 테이블을 생성합니다.
        const table = document.createElement('table');
        table.innerHTML = `
        <thead>
            <tr>
                <th>요일</th>
                <th>운동이름</th>
                <th>세트</th>
                <th>횟수</th>
                <th>휴식시간</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    `;
        const tbody = table.querySelector('tbody');

        const days = ['월요일', '화요일', '수요일', '목요일', '금요일', '토요일', '일요일'];
        Object.keys(weekRoutine).forEach(dayKey => {
            const dayPlan = weekRoutine[dayKey];
            const dayIndex = parseInt(dayKey.replace('day', '')) - 1;

            dayPlan.forEach(exercise => {
                // [보안 해결 핵심] innerHTML 대신 DOM API를 사용하여 안전하게 셀(td)을 생성합니다.
                const row = tbody.insertRow(); // 새 행(tr)을 추가합니다.

                // 각 셀에 textContent를 사용하여 데이터를 '순수 텍스트'로 삽입합니다.
                // 이렇게 하면 <script> 같은 태그가 들어와도 코드로 실행되지 않고 문자열 그대로 보입니다.
                row.insertCell().textContent = days[dayIndex];
                row.insertCell().textContent = exercise.exerciseName;
                row.insertCell().textContent = exercise.sets;
                row.insertCell().textContent = exercise.reps;
                row.insertCell().textContent = exercise.restTimeInSeconds + "초";
            });

            routineDetailsForSave.push({
                day: days[dayIndex],
                routine: dayPlan
            });
        });

        container.appendChild(table);

        // 5. '루틴 저장하기' 버튼에 이벤트 리스너를 추가합니다.
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.addEventListener('click', async function() {
            this.textContent = '저장 중...';
            this.disabled = true;

            const payload = {
                requestParams: requestParams,
                routineDetails: routineDetailsForSave
            };

            try {
                const response = await fetch('/exercise/api/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (response.ok) {
                    showToast('루틴이 성공적으로 저장되었습니다.', false);
                    sessionStorage.removeItem('exerciseResult');
                    sessionStorage.removeItem('requestParams');
                    setTimeout(() => window.location.href = '/history', 1500);
                } else {
                    throw new Error(result.error || '저장에 실패했습니다.');
                }
            } catch (error) {
                console.error(error);
                showToast(error.message, true);
                this.textContent = '루틴 저장하기';
                this.disabled = false;
            }
        });

        // 토스트 메시지 표시 함수
        function showToast(message, isError) {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.textContent = message;
            toast.className = 'toast show';
            toast.style.backgroundColor = isError ? '#dc3545' : '#28a745';
            setTimeout(() => {
                toast.className = toast.className.replace('show', '');
            }, 3000);
        }
    });
</script>
<script th:src="@{/js/header.js}"></script>
</body>
</html>